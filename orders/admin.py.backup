"""
Административная панель для приложения orders
"""

from django.contrib import admin
from django.utils.html import format_html
from django.urls import reverse
from django.utils.safestring import mark_safe
from .models import Order, OrderItem, OrderHistory, Payment


@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    """
    Административная панель для модели Order
    """
    list_display = (
        'order_number', 'get_customer_name', 'get_customer_email', 'total_amount',
        'status', 'payment_status', 'created_at'
    )
    list_filter = (
        'status', 'payment_status', 'delivery_status', 
        'payment_method', 'delivery_method', 'created_at'
    )
    search_fields = (
        'order_number', 'customer_name', 'customer_email', 
        'customer_phone', 'user__username'
    )
    readonly_fields = (
        'order_number', 'created_at', 'updated_at',
        'shipped_at', 'delivered_at', 'total_amount'
    )
    
    fieldsets = (
        (None, {
            'fields': ('order_number', 'user', 'cart', 'status', 'payment_status', 'delivery_status')
        }),
        ('Информация о клиенте', {
            'fields': (
                'customer_name', 'customer_email', 'customer_phone',
                'delivery_address', 'delivery_method'
            )
        }),
        ('Оплата', {
            'fields': ('payment_method',)
        }),
        ('Финансовая информация', {
            'fields': (
                'subtotal', 'discount_amount', 'tax_amount', 
                'shipping_cost', 'used_bonus_points', 'bonus_discount',
                'discount_code', 'total'
            )
        }),
        ('Комментарии', {
            'fields': ('customer_comment', 'admin_comment')
        }),
        ('Доставка', {
            'fields': (
                'delivery_date', 'delivery_time_slot', 'delivery_tracking_number'
            )
        }),
        ('Временные метки', {
            'fields': (
                'created_at', 'updated_at', 'shipped_at', 
                'delivered_at', 'cancelled_at'
            ),
            'classes': ('collapse',)
        }),
    )
    
    actions = ['mark_as_shipped', 'mark_as_delivered', 'cancel_orders']
    inlines = []
    
    def get_queryset(self, request):
        qs = super().get_queryset(request)
        return qs.select_related('user', 'delivery_address')
    
    def get_customer_name(self, obj):
        if obj.user:
            return obj.user.get_full_name()
        return "Незарегистрированный"
    get_customer_name.short_description = 'Клиент'
    
    def get_customer_email(self, obj):
        if obj.user:
            return obj.user.email
        return "Не указан"
    get_customer_email.short_description = 'Email'
    
    def mark_as_shipped(self, request, queryset):
        """Отметить заказы как отправленные"""
        updated = queryset.update(status='delivery', shipped_at=timezone.now())
        self.message_user(request, f'{updated} заказов отмечены как отправленные.')
    mark_as_shipped.short_description = 'Отметить как отправленные'
    
    def mark_as_delivered(self, request, queryset):
        """Отметить заказы как доставленные"""
        updated = queryset.update(status='completed', delivered_at=timezone.now())
        self.message_user(request, f'{updated} заказов отмечены как доставленные.')
    mark_as_delivered.short_description = 'Отметить как доставленные'
    
    def cancel_orders(self, request, queryset):
        """Отменить заказы"""
        cancelled = 0
        for order in queryset:
            if order.can_be_cancelled():
                order.cancel_order()
                cancelled += 1
        self.message_user(request, f'{cancelled} заказов отменено.')
    cancel_orders.short_description = 'Отменить заказы'


class OrderItemInline(admin.TabularInline):
    """
    Встроенная админка для товаров в заказе
    """
    model = OrderItem
    extra = 0
    readonly_fields = (
        'product_name', 'product_sku',
        'unit_price', 'total_price'
    )
    autocomplete_fields = ('product',)
    
    def get_queryset(self, request):
        qs = super().get_queryset(request)
        return qs.select_related('product')


class OrderHistoryInline(admin.TabularInline):
    """
    Встроенная админка для истории заказа
    """
    model = OrderHistory
    extra = 0
    readonly_fields = ('created_at', 'changed_by')
    autocomplete_fields = ('changed_by',)


# Расширенная админка для Order с встроенными элементами
class OrderAdminExtended(OrderAdmin):
    """
    Расширенная админка для заказов с встроенными товарами и историей
    """
    inlines = [OrderItemInline, OrderHistoryInline]
    
    def get_readonly_fields(self, request, obj=None):
        readonly = list(self.readonly_fields)
        if obj:  # При редактировании заказа
            readonly.extend(['order_number', 'created_at'])
        return readonly
    
    def save_related(self, request, form, formsets, change):
        super().save_related(request, form, formsets, change)
        if change:  # При изменении заказа
            # Создать запись в истории
            if not form.instance.history.exists():
                OrderHistory.objects.create(
                    order=form.instance,
                    status=form.instance.status,
                    payment_status=form.instance.payment_status,
                    delivery_status=form.instance.delivery_status,
                    changed_by=request.user
                )


@admin.register(OrderItem)
class OrderItemAdmin(admin.ModelAdmin):
    """
    Административная панель для модели OrderItem
    """
    list_display = (
        'order', 'product_name', 'quantity',
        'unit_price', 'total_price'
    )
    list_filter = ('created_at',)
    search_fields = (
        'order__order_number', 'order__customer_name',
        'product__name', 'product__sku'
    )
    readonly_fields = (
        'product_name', 'product_sku',
        'total_price', 'created_at', 'updated_at'
    )
    
    fieldsets = (
        (None, {
            'fields': ('order', 'product', 'quantity', 'unit_price')
        }),
        ('Информация о товаре на момент заказа', {
            'fields': ('product_name', 'product_sku', 'product_image', 'weight'),
            'classes': ('collapse',)
        }),
        ('Расчет стоимости', {
            'fields': ('total_price', 'total_weight'),
            'classes': ('collapse',)
        }),
        ('Статус', {
            'fields': ('status',),
        }),
        ('Атрибуты товара', {
            'fields': ('attributes',),
            'classes': ('collapse',)
        }),
        ('Метаданные', {
            'fields': ('created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    def get_queryset(self, request):
        qs = super().get_queryset(request)
        return qs.select_related('order', 'product')
    
    def get_order_number(self, obj):
        return obj.order.order_number
    get_order_number.short_description = 'Номер заказа'
    
    def get_total_weight(self, obj):
        return f"{obj.get_total_weight()} кг"
    get_total_weight.short_description = 'Общий вес'


@admin.register(OrderHistory)
class OrderHistoryAdmin(admin.ModelAdmin):
    """
    Административная панель для модели OrderHistory
    """
    list_display = (
        'order', 'status', 'payment_status', 
        'delivery_status', 'changed_by', 'created_at'
    )
    list_filter = ('status', 'payment_status', 'delivery_status', 'created_at')
    search_fields = (
        'order__order_number', 'order__customer_name',
        'changed_by__username'
    )
    readonly_fields = ('created_at',)
    
    def get_queryset(self, request):
        qs = super().get_queryset(request)
        return qs.select_related('order', 'changed_by')
    
    def get_order_number(self, obj):
        return obj.order.order_number
    get_order_number.short_description = 'Номер заказа'


@admin.register(Payment)
class PaymentAdmin(admin.ModelAdmin):
    """
    Административная панель для модели Payment
    """
    list_display = (
        'order', 'payment_type', 'amount', 'status',
        'transaction_id', 'created_at', 'completed_at'
    )
    list_filter = (
        'payment_type', 'status', 'payment_system',
        'created_at', 'completed_at'
    )
    search_fields = (
        'order__order_number', 'transaction_id', 
        'external_id'
    )
    readonly_fields = (
        'created_at', 'updated_at', 'completed_at'
    )
    
    fieldsets = (
        (None, {
            'fields': ('order', 'payment_type', 'amount', 'status')
        }),
        ('Информация о платежной системе', {
            'fields': (
                'payment_system', 'transaction_id', 'external_id'
            ),
        }),
        ('Дополнительная информация', {
            'fields': ('payment_data', 'error_message'),
            'classes': ('collapse',)
        }),
        ('Временные метки', {
            'fields': ('created_at', 'updated_at', 'completed_at'),
            'classes': ('collapse',)
        }),
    )
    
    def get_queryset(self, request):
        qs = super().get_queryset(request)
        return qs.select_related('order')
    
    def get_order_number(self, obj):
        return obj.order.order_number
    get_order_number.short_description = 'Номер заказа'


# Перерегистрируем Order с расширенной админкой
admin.site.unregister(Order)
admin.site.register(Order, OrderAdminExtended)


# Фильтры для заказов
class OrderStatusFilter(admin.SimpleListFilter):
    """
    Фильтр по статусу заказа
    """
    title = 'Статус заказа'
    parameter_name = 'status'
    
    def lookups(self, request, model_admin):
        return (
            ('processing', 'Обработка'),
            ('assembly', 'Сборка'),
            ('delivery', 'Доставка'),
            ('completed', 'Выполнен'),
            ('cancelled', 'Отменен'),
        )
    
    def queryset(self, request, queryset):
        if self.value():
            return queryset.filter(status=self.value())
        return queryset


class PaymentStatusFilter(admin.SimpleListFilter):
    """
    Фильтр по статусу оплаты
    """
    title = 'Статус оплаты'
    parameter_name = 'payment_status'
    
    def lookups(self, request, model_admin):
        return (
            ('pending', 'Ожидает оплаты'),
            ('paid', 'Оплачен'),
            ('failed', 'Ошибка оплаты'),
            ('refunded', 'Возвращен'),
        )
    
    def queryset(self, request, queryset):
        if self.value():
            return queryset.filter(payment_status=self.value())
        return queryset


# Применяем фильтры к админке заказов
OrderAdminExtended.list_filter = OrderAdmin.list_filter + (OrderStatusFilter, PaymentStatusFilter)
